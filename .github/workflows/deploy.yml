name: Deploy to Hetzner

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  DEPLOY_PATH: /opt/whatsapp-bot

jobs:
  deploy:
    name: Deploy WhatsApp Bot
    runs-on: ubuntu-latest

    steps:
    - name: 🔑 Configure SSH
      run: |
        mkdir -p ~/.ssh
        chmod 700 ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts 2>/dev/null

    - name: 🚀 Deploy to Server
      run: |
        ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'ENDSSH'
        set -e

        echo "🚀 Starting deployment..."

        # Navegar para diretório do projeto
        cd /opt/whatsapp-bot

        # Atualizar código do Git
        echo "📥 Pulling latest changes from GitHub..."
        git fetch --all
        git reset --hard origin/main
        git pull origin main

        # Mostrar commit atual
        echo "📍 Current commit:"
        git log -1 --oneline

        # Usar Docker Compose v2 (plugin do Docker)
        echo "🔨 Building and starting containers..."
        docker compose down 2>/dev/null || true
        docker compose build --no-cache
        docker compose up -d

        # Aguardar container iniciar
        echo "⏳ Waiting for container to start..."
        sleep 15

        # Verificar se container está rodando
        CONTAINER_NAME=$(docker ps --filter "name=whatsapp-bot" --format "{{.Names}}" | head -n 1)

        if [ -n "$CONTAINER_NAME" ]; then
          echo "✅ Container $CONTAINER_NAME is running!"

          # Health check
          echo "🏥 Checking health..."
          if curl -f http://localhost:8000/health; then
            echo "✅ Health check passed!"
          else
            echo "⚠️ Health check failed, but container is running"
          fi

          # Mostrar logs recentes
          echo "📋 Recent logs:"
          docker logs $CONTAINER_NAME --tail 15

          # Limpar imagens antigas
          echo "🧹 Cleaning up old images..."
          docker image prune -f

          echo "🎉 Deployment complete!"
        else
          echo "❌ Container failed to start!"
          docker compose logs --tail 50
          exit 1
        fi

        ENDSSH

    - name: ✅ Deployment Success
      if: success()
      run: |
        echo "✅ Deploy realizado com sucesso!"
        echo "🌐 Bot disponível em: https://bot.automacaovn.shop"

    - name: ❌ Deployment Failed
      if: failure()
      run: |
        echo "❌ Deploy falhou! Verifique os logs acima."
        exit 1
