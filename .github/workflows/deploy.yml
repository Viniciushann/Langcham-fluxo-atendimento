name: Deploy to Hetzner

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  DEPLOY_PATH: /opt/whatsapp-bot

jobs:
  deploy:
    name: Deploy WhatsApp Bot
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ”‘ Configure SSH
      run: |
        mkdir -p ~/.ssh
        chmod 700 ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts 2>/dev/null

    - name: ğŸš€ Deploy to Server
      run: |
        ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'ENDSSH'
        set -e

        echo "ğŸš€ Starting deployment..."

        # Navegar para diretÃ³rio do projeto
        cd /opt/whatsapp-bot

        # Atualizar cÃ³digo do Git
        echo "ğŸ“¥ Pulling latest changes from GitHub..."
        git fetch --all
        git reset --hard origin/main
        git pull origin main

        # Mostrar commit atual
        echo "ğŸ“ Current commit:"
        git log -1 --oneline

        # Build da imagem Docker
        echo "ğŸ”¨ Building Docker image..."
        docker build -t whatsapp-bot-langchain:latest .

        # Deploy via Docker Stack (Swarm mode)
        echo "ğŸš€ Deploying to Docker Swarm..."
        docker stack rm whatsapp-bot 2>/dev/null || true
        sleep 5
        docker stack deploy -c docker-compose.swarm.yml whatsapp-bot

        # Aguardar container iniciar
        echo "â³ Waiting for container to start..."
        sleep 15

        # Verificar status do stack
        echo "ğŸ“Š Stack status:"
        docker stack ps whatsapp-bot

        echo ""
        echo "ğŸ” Service status:"
        docker stack services whatsapp-bot

        # Aguardar serviÃ§o ficar pronto
        echo ""
        echo "â³ Waiting for service to be ready..."
        sleep 10

        # Verificar se serviÃ§o estÃ¡ rodando
        SERVICE_ID=$(docker service ps whatsapp-bot_whatsapp-bot -q --filter "desired-state=running" | head -n 1)

        if [ -n "$SERVICE_ID" ]; then
          echo "âœ… Service is running!"

          # Health check
          echo "ğŸ¥ Checking health..."
          if curl -f http://localhost:8000/health; then
            echo "âœ… Health check passed!"
          else
            echo "âš ï¸ Health check pending, but service is running"
          fi

          # Mostrar logs recentes
          echo ""
          echo "ğŸ“‹ Recent logs:"
          docker service logs whatsapp-bot_whatsapp-bot --tail 20 --no-trunc

          # Limpar imagens antigas
          echo ""
          echo "ğŸ§¹ Cleaning up old images..."
          docker image prune -f

          echo ""
          echo "ğŸ‰ Deployment complete!"
        else
          echo "âŒ Service failed to start!"
          docker service logs whatsapp-bot_whatsapp-bot --tail 50
          exit 1
        fi

        ENDSSH

    - name: âœ… Deployment Success
      if: success()
      run: |
        echo "âœ… Deploy realizado com sucesso!"
        echo "ğŸŒ Bot disponÃ­vel em: https://bot.automacaovn.shop"

    - name: âŒ Deployment Failed
      if: failure()
      run: |
        echo "âŒ Deploy falhou! Verifique os logs acima."
        exit 1
