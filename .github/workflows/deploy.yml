# ========================================
# GitHub Actions - Deploy AutomÃ¡tico
# ========================================
# Faz deploy automÃ¡tico no servidor Hetzner
# quando vocÃª faz push na branch main
# ========================================

name: Deploy to Hetzner

on:
  push:
    branches:
      - main
      - production
  workflow_dispatch:  # Permite executar manualmente

jobs:
  deploy:
    name: Deploy WhatsApp Bot
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout do cÃ³digo
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Setup Python (para validaÃ§Ãµes)
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # 3. Validar cÃ³digo Python
      - name: Validate Python syntax
        run: |
          python -m py_compile src/**/*.py || echo "Validation complete"

      # 4. Deploy via SSH
      - name: Deploy to Server
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
        run: |
          # Criar diretÃ³rio SSH
          mkdir -p ~/.ssh

          # Salvar chave privada
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

          # Adicionar host ao known_hosts
          ssh-keyscan -H $SERVER_HOST >> ~/.ssh/known_hosts

          # Executar deploy via SSH
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no $SERVER_USER@$SERVER_HOST << 'ENDSSH'
            echo "ðŸš€ Starting deployment..."

            # Navegar para o diretÃ³rio do projeto
            cd /opt/whatsapp-bot || exit 1

            # Pull das mudanÃ§as
            echo "ðŸ“¥ Pulling latest changes..."
            git pull origin main

            # Verificar se hÃ¡ mudanÃ§as no requirements.txt
            if git diff HEAD@{1} HEAD --name-only | grep -q "requirements.txt"; then
              echo "ðŸ“¦ Rebuilding Docker image (requirements changed)..."
              docker-compose build --no-cache
            else
              echo "ðŸ”„ Rebuilding Docker image..."
              docker-compose build
            fi

            # Restart do container
            echo "ðŸ”„ Restarting container..."
            docker-compose down
            docker-compose up -d

            # Aguardar container iniciar
            echo "â³ Waiting for container to start..."
            sleep 15

            # Verificar se estÃ¡ rodando
            CONTAINER_NAME=$(docker ps --filter "name=whatsapp-bot" --format "{{.Names}}" | head -n 1)

            if [ -n "$CONTAINER_NAME" ]; then
              echo "âœ… Container $CONTAINER_NAME is running!"

              # Verificar health
              echo "ðŸ¥ Checking health..."
              curl -f http://localhost:8000/health || echo "âš ï¸ Health check pending..."

              # Mostrar logs recentes
              echo "ðŸ“‹ Recent logs:"
              docker logs $CONTAINER_NAME --tail 10
            else
              echo "âŒ Container failed to start!"
              docker-compose logs --tail 50
              exit 1
            fi

            # Limpar imagens antigas
            echo "ðŸ§¹ Cleaning up old images..."
            docker image prune -f

            echo "ðŸŽ‰ Deployment complete!"
          ENDSSH

      # 5. Notificar sucesso
      - name: Deployment Success
        if: success()
        run: |
          echo "âœ… Deploy realizado com sucesso!"
          echo "ðŸŒ Bot disponÃ­vel em: https://bot.${{ secrets.DOMAIN }}"

      # 6. Notificar falha
      - name: Deployment Failed
        if: failure()
        run: |
          echo "âŒ Deploy falhou! Verifique os logs acima."
          exit 1
