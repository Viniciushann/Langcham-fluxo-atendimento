name: Deploy to Hetzner

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  DEPLOY_PATH: /opt/whatsapp-bot

jobs:
  deploy:
    name: Deploy WhatsApp Bot
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ”‘ Configure SSH
      run: |
        mkdir -p ~/.ssh
        chmod 700 ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts 2>/dev/null

    - name: ğŸš€ Deploy to Server
      run: |
        ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'ENDSSH'
        set -e

        echo "ğŸš€ Starting deployment..."

        # Navegar para diretÃ³rio do projeto
        cd /opt/whatsapp-bot

        # Atualizar cÃ³digo do Git
        echo "ğŸ“¥ Pulling latest changes from GitHub..."
        git fetch --all
        git reset --hard origin/main
        git pull origin main

        # Mostrar commit atual
        echo "ğŸ“ Current commit:"
        git log -1 --oneline

        # Usar Docker Compose v2 (plugin do Docker)
        echo "ğŸ”¨ Building and starting containers..."
        docker compose down 2>/dev/null || true
        docker compose build --no-cache
        docker compose up -d

        # Aguardar container iniciar
        echo "â³ Waiting for container to start..."
        sleep 15

        # Verificar se container estÃ¡ rodando
        CONTAINER_NAME=$(docker ps --filter "name=whatsapp-bot" --format "{{.Names}}" | head -n 1)

        if [ -n "$CONTAINER_NAME" ]; then
          echo "âœ… Container $CONTAINER_NAME is running!"

          # Health check
          echo "ğŸ¥ Checking health..."
          if curl -f http://localhost:8000/health; then
            echo "âœ… Health check passed!"
          else
            echo "âš ï¸ Health check failed, but container is running"
          fi

          # Mostrar logs recentes
          echo "ğŸ“‹ Recent logs:"
          docker logs $CONTAINER_NAME --tail 15

          # Limpar imagens antigas
          echo "ğŸ§¹ Cleaning up old images..."
          docker image prune -f

          echo "ğŸ‰ Deployment complete!"
        else
          echo "âŒ Container failed to start!"
          docker compose logs --tail 50
          exit 1
        fi

        ENDSSH

    - name: âœ… Deployment Success
      if: success()
      run: |
        echo "âœ… Deploy realizado com sucesso!"
        echo "ğŸŒ Bot disponÃ­vel em: https://bot.automacaovn.shop"

    - name: âŒ Deployment Failed
      if: failure()
      run: |
        echo "âŒ Deploy falhou! Verifique os logs acima."
        exit 1
