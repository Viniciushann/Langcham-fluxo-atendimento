name: Deploy to Hetzner

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  DEPLOY_PATH: /opt/whatsapp-bot

jobs:
  deploy:
    name: Deploy WhatsApp Bot
    runs-on: ubuntu-latest

    steps:
    - name: 🔑 Configure SSH
      run: |
        mkdir -p ~/.ssh
        chmod 700 ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts 2>/dev/null

    - name: 🚀 Deploy to Server
      run: |
        ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'ENDSSH'
        set -e

        echo "🚀 Starting deployment..."

        # Navegar para diretório do projeto
        cd /opt/whatsapp-bot

        # Atualizar código do Git
        echo "📥 Pulling latest changes from GitHub..."
        git fetch --all
        git reset --hard origin/main
        git pull origin main

        # Mostrar commit atual
        echo "📍 Current commit:"
        git log -1 --oneline

        # Build da imagem Docker
        echo "🔨 Building Docker image..."
        docker build -t whatsapp-bot-langchain:latest .

        # Deploy via Docker Stack (Swarm mode)
        echo "🚀 Deploying to Docker Swarm..."
        docker stack rm whatsapp-bot 2>/dev/null || true
        sleep 5
        docker stack deploy -c docker-compose.swarm.yml whatsapp-bot

        # Aguardar container iniciar
        echo "⏳ Waiting for container to start..."
        sleep 15

        # Verificar status do stack
        echo "📊 Stack status:"
        docker stack ps whatsapp-bot

        echo ""
        echo "🔍 Service status:"
        docker stack services whatsapp-bot

        # Aguardar serviço ficar pronto
        echo ""
        echo "⏳ Waiting for service to be ready..."
        sleep 10

        # Verificar se serviço está rodando
        SERVICE_ID=$(docker service ps whatsapp-bot_whatsapp-bot -q --filter "desired-state=running" | head -n 1)

        if [ -n "$SERVICE_ID" ]; then
          echo "✅ Service is running!"

          # Health check
          echo "🏥 Checking health..."
          if curl -f http://localhost:8000/health; then
            echo "✅ Health check passed!"
          else
            echo "⚠️ Health check pending, but service is running"
          fi

          # Mostrar logs recentes
          echo ""
          echo "📋 Recent logs:"
          docker service logs whatsapp-bot_whatsapp-bot --tail 20 --no-trunc

          # Limpar imagens antigas
          echo ""
          echo "🧹 Cleaning up old images..."
          docker image prune -f

          echo ""
          echo "🎉 Deployment complete!"
        else
          echo "❌ Service failed to start!"
          docker service logs whatsapp-bot_whatsapp-bot --tail 50
          exit 1
        fi

        ENDSSH

    - name: ✅ Deployment Success
      if: success()
      run: |
        echo "✅ Deploy realizado com sucesso!"
        echo "🌐 Bot disponível em: https://bot.automacaovn.shop"

    - name: ❌ Deployment Failed
      if: failure()
      run: |
        echo "❌ Deploy falhou! Verifique os logs acima."
        exit 1
